namespace Backend.Tests.Features.{{featureName}}.Endpoints.{{entitiesName}};

using Backend.Features.{{featureName}}.Core;
using Backend.Features.{{featureName}}.Endpoints.{{entitiesName}};

public class {{entityName}}UpdateTests(App app, ITestOutputHelper output) : AppTestsBase(app)
{
    [Fact]
    public async Task Update_Existing_{{entityName}}_With_Valid_Input_Returns_Ok()
    {
        await SetAuthTokenAsync();

        var created{{entityName}} = await Create{{entityName}}();

        var request = new Faker<{{entityName}}UpdateRequest>()
            .RuleFor(u => u.Name, f => f.Commerce.ProductName() + f.UniqueIndex)
            .Generate();

        var (rsp, res) = await App.Client.PUTAsync<{{entityName}}UpdateEndpoint, {{entityName}}UpdateRequest, {{entityName}}UpdateResponse>(request);

        if (rsp.StatusCode != HttpStatusCode.OK)
        {
            output.WriteLine(await rsp.Content.ReadAsStringAsync());
        }

        rsp.StatusCode.Should().Be(HttpStatusCode.OK);
        res.Should().NotBeNull();

        var dbContext = App.Services.GetRequiredService<AppDbContext>();
        var updated{{entityName}} = await dbContext.{{entitiesName}}.FirstOrDefaultAsync(p => p.Id == res.Id);
        updated{{entityName}}.Should().NotBeNull();
        updated{{entityName}}!.Name.Should().Be(request.Name);
    }

    [Fact]
    public async Task Update_NonExistent_{{entityName}}_Returns_NotFound()
    {
        await SetAuthTokenAsync();

        var request = new Faker<{{entityName}}UpdateRequest>()
            .RuleFor(u => u.Id, _ => Guid.NewGuid())
            .RuleFor(u => u.Name, f => f.Commerce.ProductName() + f.UniqueIndex)
            .Generate();

        var (rsp, _) = await App.Client.PUTAsync<{{entityName}}UpdateEndpoint, {{entityName}}UpdateRequest, ProblemDetails>(request);

        rsp.StatusCode.Should().Be(HttpStatusCode.NotFound);
    }

    private async Task<{{entityName}}CreateResponse> Create{{entityName}}()
    {
        // Before writing this test, read the {{entityName}}Configuration.cs file to identify which properties have a unique index.
        var request = new Faker<{{entityName}}CreateRequest>()
            .RuleFor(u => u.Name, f => f.Commerce.ProductName() + f.UniqueIndex)
            .Generate();

        var (rsp, res) = await App.Client.POSTAsync<{{entityName}}CreateEndpoint, {{entityName}}CreateRequest, {{entityName}}CreateResponse>(request);
        if (rsp.StatusCode != HttpStatusCode.Created)
        {
            output.WriteLine(await rsp.Content.ReadAsStringAsync());
        }
        rsp.StatusCode.Should().Be(HttpStatusCode.Created);
        return res;
    }
}