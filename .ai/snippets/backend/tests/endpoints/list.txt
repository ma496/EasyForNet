namespace Backend.Tests.Features.{{featureName}}.Endpoints.{{entitiesName}};

using Backend.Features.{{featureName}}.Endpoints.{{entitiesName}};

public class {{entityName}}ListTests(App app, ITestOutputHelper output) : AppTestsBase(app)
{
    [Fact]
    public async Task List_{{entitiesName}}()
    {
        await SetAuthTokenAsync();

        // Create multiple entities
        // Before writing this test, read the {{entityName}}Configuration.cs file to identify which properties have a unique index.
        var requests = new Faker<{{entityName}}CreateRequest>()
            .RuleFor(u => u.Name, f => f.Commerce.ProductName() + f.UniqueIndex)
            .RuleFor(u => u.Description, f => f.Commerce.ProductDescription())
            .Generate(3);

        foreach (var req in requests)
        {
            var (rsp, _) = await App.Client.POSTAsync<{{entityName}}CreateEndpoint, {{entityName}}CreateRequest, {{entityName}}CreateResponse>(req);
            if (rsp.StatusCode != HttpStatusCode.Created)
            {
                output.WriteLine(await rsp.Content.ReadAsStringAsync());
            }
        }

        // Get list of entities
        var (listRsp, listRes) = await App.Client.GETAsync<{{entityName}}ListEndpoint, {{entityName}}ListRequest, {{entityName}}ListResponse>(
            new()
            {
                Page = 1,
                PageSize = 10
            });

        listRsp.StatusCode.Should().Be(HttpStatusCode.OK);
        listRes.Items.Should().NotBeEmpty();
        listRes.Items.Count.Should().BeGreaterThanOrEqualTo(3);
    }

    [Fact]
    public async Task List_{{entitiesName}}_Pagination()
    {
        await SetAuthTokenAsync();
        
        // Create multiple entities
        // Before writing this test, read the {{entityName}}Configuration.cs file to identify which properties have a unique index.
        var requests = new Faker<{{entityName}}CreateRequest>()
            .RuleFor(u => u.Name, f => f.Commerce.ProductName() + f.UniqueIndex)
            .RuleFor(u => u.Description, f => f.Commerce.ProductDescription())
            .Generate(5);

        foreach (var req in requests)
        {
            var (rsp, _) = await App.Client.POSTAsync<{{entityName}}CreateEndpoint, {{entityName}}CreateRequest, {{entityName}}CreateResponse>(req);
            if (rsp.StatusCode != HttpStatusCode.Created)
            {
                output.WriteLine(await rsp.Content.ReadAsStringAsync());
            }
        }

        // Get first page with 2 entities
        var (page1Rsp, page1Res) = await App.Client.GETAsync<{{entityName}}ListEndpoint, {{entityName}}ListRequest, {{entityName}}ListResponse>(
            new()
            {
                Page = 1,
                PageSize = 2
            });

        page1Rsp.StatusCode.Should().Be(HttpStatusCode.OK);
        page1Res.Items.Count.Should().Be(2);

        // Get second page
        var (page2Rsp, page2Res) = await App.Client.GETAsync<{{entityName}}ListEndpoint, {{entityName}}ListRequest, {{entityName}}ListResponse>(
            new()
            {
                Page = 2,
                PageSize = 2
            });

        page2Rsp.StatusCode.Should().Be(HttpStatusCode.OK);
        page2Res.Items.Count.Should().Be(2);
        page2Res.Should().NotBeEquivalentTo(page1Res);
    }
}