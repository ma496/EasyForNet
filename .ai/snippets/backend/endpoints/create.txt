namespace EasyBiz.Features.{{featureName}}.Endpoints.{{entitiesName}};

using EasyBiz.Features.{{featureName}}.Core.Entities;

public sealed class {{entityName}}CreateEndpoint(AppDbContext dbContext) : Endpoint<{{entityName}}CreateRequest, {{entityName}}CreateResponse>
{
    public override void Configure()
    {
        Post("");
        Group<{{entitiesName}}Group>();
        Permissions(Allow.{{entityName}}_Create);
    }

    public override async Task HandleAsync({{entityName}}CreateRequest req, CancellationToken ct)
    {
        var requestMapper = new {{entityName}}CreateRequestMapper();
        var entity = requestMapper.Map(req);
        
        await dbContext.{{entitiesName}}.AddAsync(entity, ct);
        await dbContext.SaveChangesAsync(ct);

        var responseMapper = new {{entityName}}CreateResponseMapper();
        var response = responseMapper.Map(entity);

        await SendAsync(response, 201, cancellation: ct);
    }
}

public class {{entityName}}CreateRequest(string Name, string? Description, Guid? {{foreignKeyName}}Id, ICollection<{{childEntityName}}CreateRequest> {{childEntitiesName}});
public class {{childEntityName}}CreateRequest(string Name);

public sealed class {{entityName}}CreateValidator : Validator<{{entityName}}CreateRequest>
{
    public {{entityName}}CreateValidator()
    {
        RuleFor(x => x.Name).NotEmpty().MinimumLength(3).MaximumLength(100);
        RuleFor(x => x.Description).MinimumLength(10).MaximumLength(500);
        RuleForEach(x => x.{{childEntitiesName}}).SetValidator(new {{childEntityName}}CreateValidator());
    }
}
public sealed class {{childEntityName}}CreateValidator : Validator<{{childEntityName}}CreateRequest>
{
    public {{childEntityName}}CreateValidator()
    {
        RuleFor(x => x.Name).NotEmpty().MinimumLength(3).MaximumLength(100);
    }
}

public class {{entityName}}CreateResponse(Guid Id, string Name, string? Description, Guid? {{foreignKeyName}}Id, ICollection<{{childEntityName}}CreateResponse> {{childEntitiesName}});
public class {{childEntityName}}CreateResponse(Guid Id, string Name);

[Mapper(RequiredMappingStrategy = RequiredMappingStrategy.Source)]
public partial class {{entityName}}CreateRequestMapper
{
    public partial {{entityName}} Map({{entityName}}CreateRequest request);
}

[Mapper(RequiredMappingStrategy = RequiredMappingStrategy.Target)]
public partial class {{entityName}}CreateResponseMapper
{
    public partial {{entityName}}CreateResponse Map({{entityName}} entity);
}