namespace Backend.Features.{{featureName}}.Endpoints.{{entitiesName}};

using Backend.Features.{{featureName}}.Core.Entities;

public sealed class {{entityName}}ListEndpoint(AppDbContext dbContext) : Endpoint<{{entityName}}ListRequest, {{entityName}}ListResponse>
{
    public override void Configure()
    {
        Get("");
        Group<{{entitiesName}}Group>();
        Permissions(Allow.{{entityName}}_View);
    }

    public override async Task HandleAsync({{entityName}}ListRequest req, CancellationToken ct)
    {
        var query = dbContext.{{entitiesName}}
            .AsNoTracking()
            .AsQueryable();

        var search = req.Search?.Trim().ToLowerInvariant();
        if (!string.IsNullOrWhiteSpace(search))
        {
            query = query.Where(x => x.Name.ToLowerInvariant().Contains(search)
                                     || (x.Description != null && x.Description.ToLowerInvariant().Contains(search)));
        }

        var total = await query.CountAsync(ct);
        var items = await query
            .Process(req)
            .To{{entityName}}ListDto()
            .ToListAsync(ct);

        var response = new {{entityName}}ListResponse
        {
            Items = items,
            Total = total
        };

        await SendAsync(response, cancellation: ct);
    }
}

public sealed class {{entityName}}ListRequest : ListRequestDto<{{IdTypeOfEntity}}>
{
}

public sealed class {{entityName}}ListValidator : Validator<{{entityName}}ListRequest>
{
    public {{entityName}}ListValidator()
    {
        Include(new ListRequestDtoValidator<{{IdTypeOfEntity}}>());
    }
}

public sealed class {{entityName}}ListResponse : ListDto<{{entityName}}ListDto>
{
}

public class {{entityName}}ListDto : AuditableDto<Guid>
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public Guid? {{foreignKeyName}}Id { get; set; }
    public int {{childEntityName}}Count { get; set; }
}

[Mapper(RequiredMappingStrategy = RequiredMappingStrategy.Target)]
public static partial class {{entityName}}ListDtoMapper
{
    public static partial IQueryable<{{entityName}}ListDto> To{{entityName}}ListDto(this IQueryable<{{entityName}}> query);

    private static partial {{entityName}}ListDto Map({{entityName}} {{name}});
}